<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NovaLink Chat</title>

<style>
/* Splash screen */
body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#000; color:#fff; }
.splash-container { display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; transition: all 0.5s ease; }
.neon-n { font-size:200px; color:red; text-shadow: 0 0 5px #f00,0 0 10px #f00,0 0 20px #f00,0 0 40px #ff0000; background:black; width:200px; height:200px; display:flex; justify-content:center; align-items:center; border-radius:20px; }

/* Login / Signup screen */
#loginScreen { display:none; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#111; }
input { padding:10px; margin:5px; border-radius:5px; border:none; font-size:16px; }
button { padding:10px 20px; margin:5px; font-size:16px; border:none; border-radius:5px; cursor:pointer; background:red; color:white; }
#loginScreen div { display:flex; flex-direction:column; align-items:center; }

/* Chat screen */
#chatScreen { display:none; height:100vh; display:flex; flex-direction:column; }
#groupSelect { padding:10px; }
#messages { flex:1; overflow-y:auto; padding:10px; background:#222; }
#messages div { margin-bottom:5px; }
#sendMessage { display:flex; }
#sendMessage input { flex:1; }
#sendMessage button { flex:0; }
</style>
</head>

<body>

<!-- Splash Screen -->
<div id="splash" class="splash-container">
  <div class="neon-n">N</div>
</div>

<!-- Login / Signup Screen -->
<div id="loginScreen">
  <div id="loginForm">
    <h2>Connexion</h2>
    <input type="text" id="loginUsername" placeholder="Nom d'utilisateur">
    <input type="password" id="loginPassword" placeholder="Mot de passe">
    <input type="text" id="loginNlink" placeholder="Code NLINK">
    <button id="loginBtn">Se connecter</button>
    <div id="loginError" style="color:red;"></div>
    <p>Pas de compte ? <button id="showSignup">Créer un compte</button></p>
  </div>

  <div id="signupForm" style="display:none;">
    <h2>Créer un compte</h2>
    <input type="text" id="signupUsername" placeholder="Nom d'utilisateur">
    <input type="password" id="signupPassword" placeholder="Mot de passe">
    <input type="text" id="signupNlink" placeholder="Code NLINK">
    <button id="signupBtn">Créer le compte</button>
    <button id="backToLogin">Retour</button>
    <div id="signupError" style="color:red;"></div>
  </div>
</div>

<!-- Chat Screen -->
<div id="chatScreen">
  <div id="groupSelect">
    <input type="text" id="newGroupName" placeholder="Créer un groupe">
    <button id="createGroupBtn">Créer</button>
    <input type="text" id="joinGroupCode" placeholder="Rejoindre un groupe (NLINK)">
    <button id="joinGroupBtn">Rejoindre</button>
    <div id="currentGroupName"></div>
  </div>
  <div id="messages"></div>
  <div id="sendMessage">
    <input type="text" id="messageInput" placeholder="Votre message">
    <button id="sendBtn">Envoyer</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "TON_API_KEY",
  authDomain: "ton-projet.firebaseapp.com",
  projectId: "ton-projet",
  storageBucket: "ton-projet.appspot.com",
  messagingSenderId: "TON_ID",
  appId: "TON_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Splash screen
setTimeout(() => {
  document.getElementById('splash').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}, 3000);

// Switch login/signup
document.getElementById('showSignup').onclick = () => {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('signupForm').style.display = 'flex';
};
document.getElementById('backToLogin').onclick = () => {
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('loginForm').style.display = 'flex';
};

// Login
document.getElementById('loginBtn').onclick = () => {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const nlink = document.getElementById('loginNlink').value.trim();
  if(!username || !password || !nlink){
    document.getElementById('loginError').innerText = "Remplir tous les champs";
    return;
  }
  window.currentUser = username;
  currentGroupId = nlink;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'flex';

  // Ajouter user au groupe
  db.collection("groups").doc(nlink).get().then(doc=>{
    if(doc.exists){
      const groupData = doc.data();
      if(!groupData.members.includes(username)){
        groupData.members.push(username);
        db.collection("groups").doc(nlink).update({ members: groupData.members });
      }
      document.getElementById('currentGroupName').innerText = "Groupe: " + groupData.name;
      listenMessages(nlink);
    } else {
      alert("Groupe introuvable.");
    }
  });
};

// Signup
document.getElementById('signupBtn').onclick = () => {
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value.trim();
  const nlink = document.getElementById('signupNlink').value.trim();
  if(!username || !password || !nlink){
    document.getElementById('signupError').innerText = "Remplir tous les champs";
    return;
  }
  if(password.length < 3){
    document.getElementById('signupError').innerText = "Mot de passe trop court";
    return;
  }
  window.currentUser = username;
  currentGroupId = nlink;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'flex';

  db.collection("groups").doc(nlink).get().then(doc=>{
    if(doc.exists){
      const groupData = doc.data();
      if(!groupData.members.includes(username)){
        groupData.members.push(username);
        db.collection("groups").doc(nlink).update({ members: groupData.members });
      }
      document.getElementById('currentGroupName').innerText = "Groupe: " + groupData.name;
      listenMessages(nlink);
    } else {
      alert("Groupe introuvable.");
    }
  });
};

// Group management
let currentGroupId = null;
document.getElementById('createGroupBtn').onclick = async () => {
  const name = document.getElementById('newGroupName').value.trim();
  if(!name) return;
  const docRef = await db.collection("groups").add({ name: name, members: [window.currentUser] });
  currentGroupId = docRef.id;
  document.getElementById('currentGroupName').innerText = "Groupe: " + name;
  listenMessages(currentGroupId);
};

document.getElementById('joinGroupBtn').onclick = async () => {
  const code = document.getElementById('joinGroupCode').value.trim();
  if(!code) return;
  const snapshot = await db.collection("groups").doc(code).get();
  if(!snapshot.exists){ alert("Groupe introuvable"); return; }
  currentGroupId = code;
  const groupData = snapshot.data();
  if(!groupData.members.includes(window.currentUser)){
    groupData.members.push(window.currentUser);
    await db.collection("groups").doc(code).update({ members: groupData.members });
  }
  document.getElementById('currentGroupName').innerText = "Groupe: " + groupData.name;
  listenMessages(currentGroupId);
};

// Chat
document.getElementById('sendBtn').onclick = () => {
  const msgInput = document.getElementById('messageInput');
  if(!msgInput.value || !currentGroupId) return;
  db.collection("groups").doc(currentGroupId).collection("messages").add({
    sender: window.currentUser,
    text: msgInput.value,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value = '';
};

function listenMessages(groupId){
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  db.collection("groups").doc(groupId).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      messagesDiv.innerHTML = '';
      snapshot.forEach(doc=>{
        const m = doc.data();
        const div = document.createElement('div');
        div.textContent = m.sender + ": " + m.text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    });
}
</script>

</body>
</html>
